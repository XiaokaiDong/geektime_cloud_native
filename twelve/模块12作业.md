# 模块12作业

## 作业要求

> 把我们的 httpserver 服务以 Istio Ingress Gateway 的形式发布出来。以下是你需要考虑的几点：
>
> - 如何实现安全保证；
> - 七层路由规则；
> - 考虑 open tracing 的接入。

## 解答

由于本人工作中使用java，故本次作业使用JAVA + Spring Boot实现而不是go语言版的HTTPServer 。使用的Java程序和模块10作业中用的是同一个。

### 编写Dockerfile

```dockerfile
FROM openjdk:8-alpine
LABEL seg=card
COPY ./cncamp-0.0.1-SNAPSHOT.jar /app/
EXPOSE 8080
WORKDIR /app
ENTRYPOINT ["nohup", "java"]
CMD ["-server", "-Xmx1G", "-Xms1G", "-XX:+UseG1GC", "-XX:MaxGCPauseMillis=20", "-Djava.security.egd=file:/dev/./urandom", "-XX:InitiatingHeapOccupancyPercent=35", "-XX:+DisableExplicitGC", "-Djava.awt.headless=true", "-jar", "cncamp-0.0.1-SNAPSHOT.jar", ">/dev/null", "2>&1", "&"]
```

### 构建镜像

```shell
sudo docker build -t dxktt/cncamp:2.0 .
sudo docker login
sudo docker push dxktt/cncamp:2.0
```

### 部署服务到K8S

使用`spring-boot-service.yaml`

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myservice
spec:
  replicas: 1
  selector:
    matchLabels:
      app: myservice
  template:
    metadata:
      labels:
        app: myservice
    spec:
      containers:
        - name: myservice
          imagePullPolicy: IfNotPresent
          image: dxktt/cncamp:2.0
          ports:
            - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: myservice
spec:
  ports:
    - name: myservice
      port: 8080
      protocol: TCP
      targetPort: 8080
  selector:
    app: myservice
```

执行命令

```shell
kubectl create -f spring_boot_service.yaml
```

### 使用Istio发布出去

使用如下的文件`istio-specs.yaml`

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: myservice
spec:
  gateways:
    - myservice
  hosts:
    - myservice.cncamp.io
  http:
    - match:
        - port: 8080
      route:
        - destination:
            host: myservice.default.svc.cluster.local
            port:
              number: 8080
---
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: myservice
spec:
  selector:
    istio: ingressgateway
  servers:
    - hosts:
        - myservice.cncamp.io
      port:
        name: myservice
        number: 8080
        protocol: HTTP
```

执行命令

```shell
kubectl create -f istio-specs.yaml 
```

首先查看网关地址

```shell
$ k get svc -n istio-system
NAME                   TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                                                                      AGE
istio-egressgateway    ClusterIP      10.105.107.146   <none>        80/TCP,443/TCP                                                               175m
istio-ingressgateway   LoadBalancer   10.111.225.251   <pending>     15021:32058/TCP,80:32261/TCP,443:31116/TCP,31400:31126/TCP,15443:32748/TCP   175m
istiod                 ClusterIP      10.104.17.132    <none>        15010/TCP,15012/TCP,443/TCP,15014/TCP
```

网关地址为10.111.225.251，进行访问，可以看见返回结果

```shell
$ curl -H"Host: myservice.cncamp.io" 10.111.225.251:8080/user -v
*   Trying 10.0.0.137:8080...
* TCP_NODELAY set
* Connected to 10.0.0.137 (10.0.0.137) port 8080 (#0)
> GET /user HTTP/1.1
> Host: myservice.cncamp.io
> User-Agent: curl/7.68.0
> Accept: */*
> 
* Mark bundle as not supporting multiuse
< HTTP/1.1 200 OK
< content-type: application/json
< date: Wed, 22 Dec 2021 15:45:35 GMT
< x-envoy-upstream-service-time: 406
< server: istio-envoy
< transfer-encoding: chunked
< 
* Connection #0 to host 10.0.0.137 left intact
{"id":1,"name":"tt"}
```

### 发布HTTPS服务

1. 签发一对公私钥

   ```shell
   openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -subj '/O=cncamp Inc./CN=*.cncamp.io' -keyout cncamp.io.key -out cncamp.io.crt
   ```

2. 用这个公私鈅创建secret

   ```shell
   kubectl create secret tls cncamp-credential --key=cncamp.io.key --cert=cncamp.io.crt
   ```

3. 使用上面的secret发布HTTPS服务，仍然是涉及VirtualService和Gateway对象，文件`istio-specs-https.yaml`的内容如下

   ```yaml
   apiVersion: networking.istio.io/v1beta1
   kind: VirtualService
   metadata:
     name: httpsmyservice
   spec:
     gateways:
       - httpsmyservice
     hosts:
       - httpsmyservice.cncamp.io
     http:
       - match:
           - port: 8483
         route:
           - destination:
               host: myservice.default.svc.cluster.local
               port:
                 number: 8080
   ---
   apiVersion: networking.istio.io/v1beta1
   kind: Gateway
   metadata:
     name: httpsmyservice
   spec:
     selector:
       istio: ingressgateway
     servers:
       - hosts:
           - httpsmyservice.cncamp.io
         port:
           name: httpsmyservice
           number: 8483
           protocol: HTTPS
         tls:
           mode: SIMPLE
           credentialName: cncamp-credential
   ```

   创建之

   ```yaml
   $ k create -f istio-specs-https.yaml
   virtualservice.networking.istio.io/httpsmyservice created
   gateway.networking.istio.io/httpsmyservice created
   ```

   用带有TLSInspector机制的curl命令访问访问

   ```shell
   curl --resolve httpsmyservice.cncamp.io:8483:10.111.225.251 https://httpsmyservice.cncamp.io:8483/user -v -k
   ```

   ### TODO

   在以非HTTPS的形式发布服务时，使用istio-ingressgateway的服务地址进行curl不成功，只有使用POD的地址才可以成功，HTTPS服务干脆无法访问，需要排查。
